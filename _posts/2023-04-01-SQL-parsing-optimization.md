---
title: SQL 파싱과 최적화
author: avokey
date: 2023-04-01 18:32:00
categories: [DB, Tuning]
tags: [Tuning, Optimization, DBMS, SQL]
---
<br>![Desktop View](/common/dbms.jpg){: width="400" height="300" }
_Fig 1. DBMS_


SQL 튜닝을 본격적으로 시작하기에 앞서 옵티마이저가 SQL을 어떻게 처리하는지, 서버 프로세스는 데이터를 어떻게 읽고 저장하는지 이번 포스트에서 살펴보려고 합니다. DW 설계를 마치고 본격적으로 구축을 시작하기 전에 미리 튜닝 개념을 잡아놓고 싶었습니다. 앞으론 쿼리를 짤 때 어떤 관점으로 쿼리를 바라봐야하는지 개인적으로 공부하면 도움이 될거같아서 시작한 스터디이지만 마무리가 어떻게 될진 모르겠네요! 그래도 일단 SQL 튜닝의 세계로 여행을 떠나봅시다!

# SQL 정의

아래 두 테이블을 부서번호로 조인해서 사원명 순으로 정렬하는 로직을 떠올려봅시다.

![](/230413/1-1.jpeg){: width="800" height="600" }

~~~sql
SELECT E.EMPNO, E.ENAME, E.JOB, E.DEPTNO, D.DNAME, D.LOC
FROM EMP E INNER JOIN DEPT D
ON E.DEPTNO = D.DEPTNO
ORDER BY E.ENAME;
~~~

요즘에는 위와 같이 SQL로 간단히 처리 할 수 있었지만 20 ~ 30년 전만해도 이런 로직을 어렵게 프로그래밍으로 풀어냈다고 합니다..

## SQL이란?

Structured Query Language의 줄임말이며 말 그대로 `구조적 질의 언어`입니다. 위키피디아에서는 아래와 같이 정의하기도 합니다:

> SQL is **set-based, declartive query lanuage**, not an imperitive language such as C or BASIC.

원하는 결과집합을 구조적, 집합적으로 선언하지만 그 결과 집합을 만드는 과정은 절차적일 수 밖에 없습니다. 즉, 프로시저(Procedure)가 필요한데 그런 **프로시저를 만들어내는 DBMS 내부 엔진이 바로 SQL 옵티마이저입니다**. 옵티마이저가 프로그래밍을 대신해 주는 셈이죠.

![](/230413/1-2.jpeg){: width="800" height="600" }

<br>

# SQL 최적화

SQL을 실행하기 전 최적화 과정을 세분화하면 다음과 같다:

## 1. SQL Parsing

사용자로부터 SQL을 전달받으면 **가장 먼저 SQL Parser가 파싱을 진행**한다. SQL 파싱이란:

- 파싱 트리 생성: SQL문을 이루는 개별 구성요소를 분석해서 파싱트리 생성
- Syntax 체크: 문법적으로 오류가 없는지 확인 - 예시로, 사용 할 수 없는 키워드를 사용했거나, 순서가 바르지 않거나 누락된 키워드 확인
- Semantic 체크: 의미상 오류가 없는지 확인 - 예시로, 존재하지 않는 테이블 또는 컬럼을 사용했는지, 사용한 오브젝트에 대한 권한이 있는지 확인

## 2. SQL Optimization

그 다음으로 SQL 최적화는 옵티마이저가 수행한다. 옵티마이저는 미리 수집한 시스템 및 오브젝트 통계정보를 바탕으로 다양한 실행경로는 생성해서 비교한후, 가장 효율적인 하나를 선택한다. 데이터베이스 성능을 결정하는 가장 핵심적인 엔진이다.

## 3. Generate Row Source

SQL 옵티마이저가 선택한 실행경로를 실제 실행 가능한 코드 또는 프로시저 형태로 **포맷팅하는 단계**입니다. Row Source Generator가 그 역할을 맡습니다.

<br>

# SQL 옵티마이저

SQL 옵티마이저는 사용자가 원하는 작업을 가장 효율적으로 수행할 수 있는 **최적의 데이터 액세스 경로를 선택해 주는 DBMS의 핵심**입니다. 옵티마이저의 최적화 단계를 요약하면 아래와 같습니다.

![](/230413/1-3.png){: width="800" height="600" }

1. 사용자로부터 전달받은 쿼리를 수행하는데 후보군이 될만한 실행계획들을 찾아냅니다
2. 데이터 딕셔너리에 미리 수집해둔 오브젝트 통계 및 시스템 통계정보를 이용해 각 실행 계획의 예상비용을 산정합니다
3. 최저비용을 나타내는 실행계획을 선택합니다.

## 실행 계획과 비용

**옵티마이저는 자동차 네비게이션과 흡사합니다**. 경로를 검색하고 나서 이동 경로를 미리 확인하는 기능이 있기 때문에 선택한 경로가 마음에 들지 않으면 이동 경로를 변경하거나, 경유지를 추가 해서 운전자가 원하는 경로로 바꿀 수 있습니다.

위와 같은 기능을 'SQL 실행경로 미리 보기'로 확인 할 수 있으며, **실행 계획(Execution Plan)**이라 합니다. 정확히 말하면 처리절차를 사용자가 확인 할 수 있게 아래와 같이 트리구조로 표현한것이 실행계획입니다.

![](/230413/1-3-1.png){: width="800" height="600" }

미리보기 기능을 통해 자신이 작성한 SQL이 테이블을 스캔하는지 인덱스를 스캔하는지도 확인 할 수 있으며, 내가 생각한 방향과 다르게 흘러가면 실행 경로를 변경 할 수 있다.

## 옵티마이저는 실행 계획을 어떻게 선택하나?

~~~sql
create table t as
	select d.no, e.*
	from HR.EMPLOYEES e, (select rownum AS no from dual connect by level <=1000) d;
~~~













